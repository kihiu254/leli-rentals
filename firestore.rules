rules_version='2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Properties - owners can manage their own properties
    match /properties/{propertyId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (resource == null || resource.data.owner == request.auth.uid);
    }
    
    // Listings - anyone can read, owners can manage their listings
    match /listings/{listingId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (resource == null || 
         get(/databases/$(database)/documents/properties/$(resource.data.property)).data.owner == request.auth.uid);
    }
    
    // Applications - users can manage their own applications
    match /applications/{applicationId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.user == request.auth.uid);
    }
    
    // Agreements - participants can read, owners can manage
    match /agreements/{agreementId} {
      allow read: if request.auth != null && 
        (resource.data.owner == request.auth.uid || resource.data.renter == request.auth.uid);
      allow write: if request.auth != null && 
        (resource == null || resource.data.owner == request.auth.uid);
    }
    
    // Payments - participants can read, owners can manage
    match /payments/{paymentId} {
      allow read: if request.auth != null && 
        (get(/databases/$(database)/documents/agreements/$(resource.data.agreement)).data.owner == request.auth.uid ||
         get(/databases/$(database)/documents/agreements/$(resource.data.agreement)).data.renter == request.auth.uid);
      allow write: if request.auth != null && 
        (resource == null || 
         get(/databases/$(database)/documents/agreements/$(resource.data.agreement)).data.owner == request.auth.uid);
    }
    
    // Support messages - users can manage their own messages
    match /support-messages/{messageId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // User favorites - users can manage their own favorites
    match /user-favorites/{favoriteId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // User bookings - users can manage their own bookings
    match /user-bookings/{bookingId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // User profiles - users can manage their own profiles
    match /userProfiles/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User reviews - anyone can read, reviewers can write
    match /userReviews/{reviewId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (resource == null || resource.data.reviewerId == request.auth.uid);
    }
    
    // Listings - anyone can read, owners can manage their listings
    match /listings/{listingId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.owner.id;
      allow update, delete: if request.auth != null && 
        (resource == null || resource.data.owner.id == request.auth.uid);
    }
    
    // Bookings - users can manage their own bookings
    match /bookings/{bookingId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // User settings - users can manage their own settings
    match /userSettings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Saved bookings - users can manage their own saved bookings
    match /savedBookings/{bookingId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // User interactions (likes, saves, views, shares) - users can manage their own interactions
    match /user_interactions/{interactionId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Listing stats - anyone can read, system can write
    match /listing_stats/{statId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Notifications - users can manage their own notifications
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Chat sessions - users can manage their own chat sessions
    match /chatSessions/{sessionId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Support tickets - users can manage their own tickets, admins can read all
    match /supportTickets/{ticketId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
      allow write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
  }
}
